# Gitの仕組み

## はじめに

Gitで管理するプロジェクトには`.git`というディレクトリがあり、その中にGitの管理情報が入っている。その中には、全てのコミットや、いろんなバージョンのファイル、ブランチ、タグといった情報が格納されている。Gitを操作するにあたり、この中身がどうなっているかを理解する必要はないし、もし中身を覚えたとしても、操作方法は変わらないまま、内部実装だけ変更になる可能性もある。それでも、Gitの仕組み、特に様々な情報が`.git`にどのように格納されているかを知っておくのは二つの理由から有用だと考える。

一つ目の理由は、「物が動く仕組み」を知っておくことが教養だからだ。車を運転するのに、アクセルを踏めば進み、ブレーキを踏めば止まり、ハンドルを回せば曲がることを知っていれば十分だ。しかし、シリンダーにガソリンが噴射され、ピストンで圧縮したところで点火し、爆発する力でピストンが押される、という直線的な動きをまず作り、それを回転運動の変換してタイヤが回っている、ということくらいは(特に理工系の学生なら)ぼんやりとは知っておいて欲しい。さらに、その点火システム(イグニッションコイル)に電磁誘導が使われていると知れば、「なるほど、学校で習った電磁気の性質がこんなところに使われているのか」と思うことであろう。

もう一つの理由は、「機能は、なんらかの方法で実装されている」という感覚を持って欲しいためだ。我々がツールに求めるのは「機能」であるが、同じ機能であっても複数の実現手段がある。例えば、東西に伸びる道路と南北に伸びる道路が交差しているとしよう。ここで「東西南北どの方向から車が来ても、残りの三方向に安全に進むことができる」という機能を実現したいとする。一つの方法は、信号を導入することだ。いま、車が西から来ているとしよう。東西の信号が青であるなら、南北の信号は赤だ。これにより、西から来た車は北と東に進むことができる。また、右折信号を設けることで、安全に南にいくこともできる。同様にして、全ての方向から全ての方向に安全に進むことができる。しかし、信号待ちが発生するため、流れは悪くなる。もう一つの方法は、ジャンクションを作ることだ。例えばクローバー型のジャンクションを作ることで信号待ちをすることなく、全ての方向に進行可能だ。ただし、広い用地面積が必要で、コストも高い。このように、同じ機能を複数の手段で実現できる場合、それぞれのメリット、デメリットを勘案して方法を選ぶことになる。

Gitはツールである。ツールであるからには何らかの機能を提供している。その機能、例えばコミットによるスナップショットの保存や、ブランチの切り替えなどが、実際にはどのように実現されているかを知っておくことは、きっと無駄にはならないであろう。以下では、Gitの実装、特に`.git`ディレクトリの中に何がどのように格納されているか紹介する。

## `.git`ディレクトリの中身

まず、`.git`の中身を見てみよう。適当なリポジトリで`ls .git`してみる。

```sh
$ ls .git
COMMIT_EDITMSG  HEAD       branches/  description  index  logs/     packed-refs
FETCH_HEAD      ORIG_HEAD  config     hooks/       info/  objects/  refs/
```

表示されるファイルはリポジトリの状態によって異なるが、概ね上記のようなファイルやディレクトリが含まれている。このうち、主なものを紹介する。

* `HEAD` - カレントブランチ(HEAD)の情報を保存するファイル
* `index` - インデックスの情報を保存するファイル
* `config` - リモートブランチや上流ブランチ等の情報を保存するファイル
* `refs` - ブランチの情報を保存するディレクトリ
* `objects` - コミットなどのオブジェクトを保存するディレクトリ

* SHA-1 (コミットID)
* Gitオブジェクト(objects)
  * blob
  * tree
  * commit
  * tag
* Gitの参照(refs)
* 操作の裏側で起きていること

## ファイルシステムの仕組み

Gitの内部構造は一種のファイルシステムとなっている。したがって、まず一般のファイルシステムがどうなっているか知っておくのは有益であろう。レポートを書くためにWordファイルを開いて編集したり、音楽を購入してファイルをダウンロードするなど、我々が普段パソコンやスマホを触る時、操作する対象は「ファイル」であることが多い。コンピュータの中でデータは論理的にはファイルという形で保存されており、それはディレクトリで整理されている。このファイルやディレクトリを管理しているのがファイルシステムである。ファイルの実態はハードディスクやSSD、SDカード、USBメモリなど、異なる物理メディアに保存されている。当然、物理メディアが異なれば読み書きする方法も異なるが、我々はそれを意識することなくファイルを扱うことができる。それは、ファイルシステムが物理的な記憶装置と我々を仲立ちし、データを「ファイル」「ディレクトリ」という形で抽象化してくれているからである。「ディレクトリやファイルを管理する」というと簡単なように見えるが、実はファイルシステムは裏でかなり複雑な処理をしている。

現在も開発が進められ、新しいファイルシステムが登場し続けている。ファイルシステムには多くの種類があり、WindowsがNT File System (NTFS)、MacがApple File System (APFS)、Linuxではext4やxfsなど、オペレーティングシステムごとに異なるシステムが採用されている。以下では、Linuxで採用例の多いext4について簡単に説明しよう。

### inode

inodeにはファイル名が含まれていないこと、ファイル名はディレクトリが管理していることを説明。

### ディレクトリ

## Gitの内部構造

まずは`objects`の中身の説明。

### blob

blobにはファイルの内容のみが含まれ、ファイル名やバージョン情報が入っていないこと、ファイル名とblobはtreeが管理していることを説明する。

### tree

### Gitの参照(refs)
